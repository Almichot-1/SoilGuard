{
    "sourceFile": "lib/screens/scan_screen.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1765222405378,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765292361996,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -196,9 +196,9 @@\n               child: Center(\r\n                 child: Container(\r\n                   padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),\r\n                   decoration: BoxDecoration(\r\n-                    color: Colors.white.withOpacity(0.2),\r\n+                    color: Colors.white.withValues(alpha: 0.2),\r\n                     borderRadius: BorderRadius.circular(20),\r\n                   ),\r\n                   child: Row(\r\n                     children: [\r\n@@ -290,9 +290,9 @@\n             decoration: BoxDecoration(\r\n               color: Colors.white,\r\n               boxShadow: [\r\n                 BoxShadow(\r\n-                  color: Colors.black.withOpacity(0.1),\r\n+                  color: Colors.black.withValues(alpha: 0.1),\r\n                   blurRadius: 10,\r\n                   offset: const Offset(0, -5),\r\n                 ),\r\n               ],\r\n@@ -323,9 +323,9 @@\n                             horizontal: 16,\r\n                             vertical: 12,\r\n                           ),\r\n                           decoration: BoxDecoration(\r\n-                            color: _getGpsColor(gps.status).withOpacity(0.1),\r\n+                            color: _getGpsColor(gps.status).withValues(alpha: 0.1),\r\n                             borderRadius: BorderRadius.circular(12),\r\n                           ),\r\n                           child: Row(\r\n                             children: [\r\n@@ -448,9 +448,9 @@\n         color: Colors.white,\r\n         borderRadius: BorderRadius.circular(20),\r\n         boxShadow: [\r\n           BoxShadow(\r\n-            color: Colors.black.withOpacity(0.2),\r\n+            color: Colors.black.withValues(alpha: 0.2),\r\n             blurRadius: 8,\r\n             offset: const Offset(0, 2),\r\n           ),\r\n         ],\r\n"
                }
            ],
            "date": 1765222405378,
            "name": "Commit-0",
            "content": "import 'dart:async';\r\nimport 'package:flutter/material.dart';\r\nimport 'package:flutter_map/flutter_map.dart';\r\nimport 'package:provider/provider.dart';\r\nimport 'package:latlong2/latlong.dart';\r\n\r\nimport '../services/ble_service.dart';\r\nimport '../services/gps_service.dart';\r\nimport '../services/recommender_service.dart';\r\nimport '../services/db_service.dart';\r\nimport '../models/soil_data.dart';\r\nimport '../models/scan_result.dart';\r\nimport '../utils/area_calculator.dart';\r\nimport '../utils/constants.dart';\r\nimport '../widgets/live_map_widget.dart';\r\nimport '../widgets/soil_data_card.dart';\r\nimport 'results_screen.dart';\r\n\r\nenum ScanState { ready, scanning, processing, complete }\r\n\r\nclass ScanScreen extends StatefulWidget {\r\n  const ScanScreen({super.key});\r\n\r\n  @override\r\n  State<ScanScreen> createState() => _ScanScreenState();\r\n}\r\n\r\nclass _ScanScreenState extends State<ScanScreen> with TickerProviderStateMixin {\r\n  ScanState _scanState = ScanState.ready;\r\n  Timer? _scanTimer;\r\n  int _elapsedSeconds = 0;\r\n  final MapController _mapController = MapController();\r\n  \r\n  late AnimationController _pulseController;\r\n  late Animation<double> _pulseAnimation;\r\n\r\n  @override\r\n  void initState() {\r\n    super.initState();\r\n    _initializeServices();\r\n    \r\n    _pulseController = AnimationController(\r\n      duration: const Duration(milliseconds: 1000),\r\n      vsync: this,\r\n    );\r\n    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.2).animate(\r\n      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),\r\n    );\r\n  }\r\n\r\n  Future<void> _initializeServices() async {\r\n    final gpsService = context.read<GpsService>();\r\n    await gpsService.initialize();\r\n  }\r\n\r\n  void _startScan() async {\r\n    final gpsService = context.read<GpsService>();\r\n    final bleService = context.read<BleService>();\r\n\r\n    // Initialize GPS\r\n    if (gpsService.status != GpsStatus.ready && \r\n        gpsService.status != GpsStatus.tracking) {\r\n      final initialized = await gpsService.initialize();\r\n      if (!initialized) {\r\n        _showError('GPS not available. Please enable location services.');\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Clear previous data\r\n    gpsService.clearTrack();\r\n    bleService.clearSamples();\r\n\r\n    // Start simulation mode for BLE (for testing without ESP32)\r\n    bleService.startSimulation();\r\n\r\n    // Start GPS tracking\r\n    await gpsService.startTracking();\r\n\r\n    setState(() {\r\n      _scanState = ScanState.scanning;\r\n      _elapsedSeconds = 0;\r\n    });\r\n\r\n    _pulseController.repeat(reverse: true);\r\n\r\n    // Start timer\r\n    _scanTimer = Timer.periodic(const Duration(seconds: 1), (timer) {\r\n      setState(() => _elapsedSeconds++);\r\n      \r\n      // Auto-center map on current location\r\n      final currentLoc = gpsService.currentLocation;\r\n      if (currentLoc != null) {\r\n        _mapController.move(currentLoc, _mapController.camera.zoom);\r\n      }\r\n    });\r\n  }\r\n\r\n  Future<void> _stopScan() async {\r\n    _scanTimer?.cancel();\r\n    _pulseController.stop();\r\n\r\n    final gpsService = context.read<GpsService>();\r\n    final bleService = context.read<BleService>();\r\n\r\n    // Stop tracking\r\n    final points = await gpsService.stopTracking();\r\n    bleService.stopSimulation();\r\n\r\n    if (points.length < 3) {\r\n      _showError('Need at least 3 GPS points to calculate area. Please try again.');\r\n      setState(() => _scanState = ScanState.ready);\r\n      return;\r\n    }\r\n\r\n    setState(() => _scanState = ScanState.processing);\r\n\r\n    // Process data\r\n    await _processResults(points, bleService.soilSamples);\r\n  }\r\n\r\n  Future<void> _processResults(List<LatLng> points, List<SoilData> samples) async {\r\n    final recommenderService = context.read<RecommenderService>();\r\n    final dbService = context.read<DatabaseService>();\r\n\r\n    // Calculate area\r\n    final areaM2 = AreaCalculator.calculateAreaM2(points);\r\n    final areaHa = AreaCalculator.m2ToHectares(areaM2);\r\n\r\n    // Average soil data\r\n    final avgSoil = SoilData.average(samples);\r\n\r\n    // Get recommendations\r\n    final recommendations = recommenderService.getRecommendations(avgSoil, areaHa);\r\n\r\n    // Create result\r\n    final result = ScanResult(\r\n      soilData: avgSoil,\r\n      areaM2: areaM2,\r\n      areaHa: areaHa,\r\n      gpsPoints: points,\r\n      recommendations: recommendations,\r\n    );\r\n\r\n    // Save to database\r\n    await dbService.saveScanResult(result);\r\n\r\n    setState(() => _scanState = ScanState.complete);\r\n\r\n    // Navigate to results\r\n    if (mounted) {\r\n      Navigator.pushReplacement(\r\n        context,\r\n        MaterialPageRoute(\r\n          builder: (_) => ResultsScreen(result: result),\r\n        ),\r\n      );\r\n    }\r\n  }\r\n\r\n  void _showError(String message) {\r\n    ScaffoldMessenger.of(context).showSnackBar(\r\n      SnackBar(\r\n        content: Text(message),\r\n        backgroundColor: Colors.red,\r\n        behavior: SnackBarBehavior.floating,\r\n      ),\r\n    );\r\n  }\r\n\r\n  String _formatDuration(int seconds) {\r\n    final mins = seconds ~/ 60;\r\n    final secs = seconds % 60;\r\n    return '${mins.toString().padLeft(2, '0')}:${secs.toString().padLeft(2, '0')}';\r\n  }\r\n\r\n  @override\r\n  void dispose() {\r\n    _scanTimer?.cancel();\r\n    _pulseController.dispose();\r\n    _mapController.dispose();\r\n    super.dispose();\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    return Scaffold(\r\n      appBar: AppBar(\r\n        title: const Text('Field Scan'),\r\n        backgroundColor: AppColors.primary,\r\n        foregroundColor: Colors.white,\r\n        actions: [\r\n          if (_scanState == ScanState.scanning)\r\n            Padding(\r\n              padding: const EdgeInsets.only(right: 16),\r\n              child: Center(\r\n                child: Container(\r\n                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),\r\n                  decoration: BoxDecoration(\r\n                    color: Colors.white.withOpacity(0.2),\r\n                    borderRadius: BorderRadius.circular(20),\r\n                  ),\r\n                  child: Row(\r\n                    children: [\r\n                      const Icon(Icons.timer, size: 18),\r\n                      const SizedBox(width: 4),\r\n                      Text(\r\n                        _formatDuration(_elapsedSeconds),\r\n                        style: const TextStyle(\r\n                          fontWeight: FontWeight.bold,\r\n                          fontSize: 16,\r\n                        ),\r\n                      ),\r\n                    ],\r\n                  ),\r\n                ),\r\n              ),\r\n            ),\r\n        ],\r\n      ),\r\n      body: Column(\r\n        children: [\r\n          // Map section (takes most of the screen)\r\n          Expanded(\r\n            flex: 3,\r\n            child: Stack(\r\n              children: [\r\n                // Live map\r\n                Consumer<GpsService>(\r\n                  builder: (context, gpsService, _) {\r\n                    return LiveMapWidget(\r\n                      trackPoints: gpsService.trackPoints,\r\n                      currentLocation: gpsService.currentLocation,\r\n                      isTracking: _scanState == ScanState.scanning,\r\n                      mapController: _mapController,\r\n                    );\r\n                  },\r\n                ),\r\n                \r\n                // Area overlay\r\n                Positioned(\r\n                  top: 16,\r\n                  left: 16,\r\n                  child: Consumer<GpsService>(\r\n                    builder: (context, gps, _) {\r\n                      final points = gps.trackPoints;\r\n                      if (points.length < 3) {\r\n                        return _InfoBadge(\r\n                          icon: Icons.straighten,\r\n                          label: 'Points: ${points.length}',\r\n                        );\r\n                      }\r\n                      final area = AreaCalculator.calculateAreaM2(points);\r\n                      final areaHa = AreaCalculator.m2ToHectares(area);\r\n                      return _InfoBadge(\r\n                        icon: Icons.square_foot,\r\n                        label: areaHa < 1 \r\n                            ? '${area.toStringAsFixed(0)} mÂ²'\r\n                            : '${areaHa.toStringAsFixed(2)} ha',\r\n                      );\r\n                    },\r\n                  ),\r\n                ),\r\n                \r\n                // Processing overlay\r\n                if (_scanState == ScanState.processing)\r\n                  Container(\r\n                    color: Colors.black54,\r\n                    child: const Center(\r\n                      child: Column(\r\n                        mainAxisSize: MainAxisSize.min,\r\n                        children: [\r\n                          CircularProgressIndicator(color: Colors.white),\r\n                          SizedBox(height: 16),\r\n                          Text(\r\n                            'Processing scan data...',\r\n                            style: TextStyle(color: Colors.white, fontSize: 18),\r\n                          ),\r\n                        ],\r\n                      ),\r\n                    ),\r\n                  ),\r\n              ],\r\n            ),\r\n          ),\r\n          \r\n          // Bottom panel\r\n          Container(\r\n            padding: const EdgeInsets.all(16),\r\n            decoration: BoxDecoration(\r\n              color: Colors.white,\r\n              boxShadow: [\r\n                BoxShadow(\r\n                  color: Colors.black.withOpacity(0.1),\r\n                  blurRadius: 10,\r\n                  offset: const Offset(0, -5),\r\n                ),\r\n              ],\r\n            ),\r\n            child: Column(\r\n              mainAxisSize: MainAxisSize.min,\r\n              children: [\r\n                // Soil data card\r\n                Consumer<BleService>(\r\n                  builder: (context, bleService, _) {\r\n                    return SoilDataCard(\r\n                      soilData: bleService.latestSample,\r\n                      sampleCount: bleService.sampleCount,\r\n                    );\r\n                  },\r\n                ),\r\n                \r\n                const SizedBox(height: 16),\r\n                \r\n                // Control buttons\r\n                Row(\r\n                  children: [\r\n                    // GPS status\r\n                    Consumer<GpsService>(\r\n                      builder: (context, gps, _) {\r\n                        return Container(\r\n                          padding: const EdgeInsets.symmetric(\r\n                            horizontal: 16,\r\n                            vertical: 12,\r\n                          ),\r\n                          decoration: BoxDecoration(\r\n                            color: _getGpsColor(gps.status).withOpacity(0.1),\r\n                            borderRadius: BorderRadius.circular(12),\r\n                          ),\r\n                          child: Row(\r\n                            children: [\r\n                              Icon(\r\n                                Icons.gps_fixed,\r\n                                color: _getGpsColor(gps.status),\r\n                              ),\r\n                              const SizedBox(width: 8),\r\n                              Text(\r\n                                '${gps.pointCount}',\r\n                                style: TextStyle(\r\n                                  fontWeight: FontWeight.bold,\r\n                                  color: _getGpsColor(gps.status),\r\n                                ),\r\n                              ),\r\n                            ],\r\n                          ),\r\n                        );\r\n                      },\r\n                    ),\r\n                    \r\n                    const SizedBox(width: 16),\r\n                    \r\n                    // Start/Stop button\r\n                    Expanded(\r\n                      child: AnimatedBuilder(\r\n                        animation: _pulseAnimation,\r\n                        builder: (context, child) {\r\n                          return Transform.scale(\r\n                            scale: _scanState == ScanState.scanning \r\n                                ? _pulseAnimation.value \r\n                                : 1.0,\r\n                            child: SizedBox(\r\n                              height: 56,\r\n                              child: ElevatedButton.icon(\r\n                                onPressed: _scanState == ScanState.processing\r\n                                    ? null\r\n                                    : (_scanState == ScanState.scanning\r\n                                        ? _stopScan\r\n                                        : _startScan),\r\n                                icon: Icon(\r\n                                  _scanState == ScanState.scanning\r\n                                      ? Icons.stop\r\n                                      : Icons.play_arrow,\r\n                                  size: 28,\r\n                                ),\r\n                                label: Text(\r\n                                  _scanState == ScanState.scanning\r\n                                      ? 'Stop Scan'\r\n                                      : 'Start Scan',\r\n                                  style: const TextStyle(\r\n                                    fontSize: 18,\r\n                                    fontWeight: FontWeight.bold,\r\n                                  ),\r\n                                ),\r\n                                style: ElevatedButton.styleFrom(\r\n                                  backgroundColor: _scanState == ScanState.scanning\r\n                                      ? Colors.red\r\n                                      : AppColors.primary,\r\n                                  foregroundColor: Colors.white,\r\n                                  shape: RoundedRectangleBorder(\r\n                                    borderRadius: BorderRadius.circular(16),\r\n                                  ),\r\n                                ),\r\n                              ),\r\n                            ),\r\n                          );\r\n                        },\r\n                      ),\r\n                    ),\r\n                  ],\r\n                ),\r\n                \r\n                // Instructions\r\n                const SizedBox(height: 12),\r\n                Text(\r\n                  _scanState == ScanState.ready\r\n                      ? 'Walk around your field perimeter to measure area'\r\n                      : _scanState == ScanState.scanning\r\n                          ? 'Keep walking... GPS is tracking your path'\r\n                          : 'Processing...',\r\n                  style: TextStyle(\r\n                    color: Colors.grey.shade600,\r\n                    fontSize: 13,\r\n                  ),\r\n                  textAlign: TextAlign.center,\r\n                ),\r\n              ],\r\n            ),\r\n          ),\r\n        ],\r\n      ),\r\n    );\r\n  }\r\n\r\n  Color _getGpsColor(GpsStatus status) {\r\n    switch (status) {\r\n      case GpsStatus.tracking:\r\n        return Colors.green;\r\n      case GpsStatus.ready:\r\n        return Colors.blue;\r\n      case GpsStatus.disabled:\r\n      case GpsStatus.noPermission:\r\n        return Colors.red;\r\n    }\r\n  }\r\n}\r\n\r\nclass _InfoBadge extends StatelessWidget {\r\n  final IconData icon;\r\n  final String label;\r\n\r\n  const _InfoBadge({required this.icon, required this.label});\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    return Container(\r\n      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),\r\n      decoration: BoxDecoration(\r\n        color: Colors.white,\r\n        borderRadius: BorderRadius.circular(20),\r\n        boxShadow: [\r\n          BoxShadow(\r\n            color: Colors.black.withOpacity(0.2),\r\n            blurRadius: 8,\r\n            offset: const Offset(0, 2),\r\n          ),\r\n        ],\r\n      ),\r\n      child: Row(\r\n        mainAxisSize: MainAxisSize.min,\r\n        children: [\r\n          Icon(icon, size: 18, color: AppColors.primary),\r\n          const SizedBox(width: 6),\r\n          Text(\r\n            label,\r\n            style: const TextStyle(\r\n              fontWeight: FontWeight.bold,\r\n              fontSize: 14,\r\n            ),\r\n          ),\r\n        ],\r\n      ),\r\n    );\r\n  }\r\n}"
        }
    ]
}