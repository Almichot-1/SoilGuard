{
    "sourceFile": "lib/services/gps_service.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1765222276020,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765292501863,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -63,9 +63,9 @@\n   /// Get current location once\r\n   Future<LatLng?> _getCurrentLocation() async {\r\n     try {\r\n       final position = await Geolocator.getCurrentPosition(\r\n-        desiredAccuracy: LocationAccuracy.high,\r\n+        locationSettings: const LocationSettings(accuracy: LocationAccuracy.high),\r\n       );\r\n       _currentLocation = LatLng(position.latitude, position.longitude);\r\n       notifyListeners();\r\n       return _currentLocation;\r\n"
                }
            ],
            "date": 1765222276020,
            "name": "Commit-0",
            "content": "import 'dart:async';\r\nimport 'package:flutter/foundation.dart';\r\nimport 'package:geolocator/geolocator.dart';\r\nimport 'package:latlong2/latlong.dart';\r\nimport 'package:permission_handler/permission_handler.dart';\r\n\r\nenum GpsStatus { disabled, noPermission, ready, tracking }\r\n\r\nclass GpsService extends ChangeNotifier {\r\n  GpsStatus _status = GpsStatus.disabled;\r\n  LatLng? _currentLocation;\r\n  final List<LatLng> _trackPoints = [];\r\n  StreamSubscription<Position>? _positionStream;\r\n  bool _isTracking = false;\r\n\r\n  GpsStatus get status => _status;\r\n  LatLng? get currentLocation => _currentLocation;\r\n  List<LatLng> get trackPoints => List.unmodifiable(_trackPoints);\r\n  bool get isTracking => _isTracking;\r\n  int get pointCount => _trackPoints.length;\r\n\r\n  /// Initialize GPS and check permissions\r\n  Future<bool> initialize() async {\r\n    try {\r\n      // Check if location services are enabled\r\n      bool serviceEnabled = await Geolocator.isLocationServiceEnabled();\r\n      if (!serviceEnabled) {\r\n        _status = GpsStatus.disabled;\r\n        notifyListeners();\r\n        return false;\r\n      }\r\n\r\n      // Check permissions\r\n      var permission = await Permission.location.status;\r\n      if (permission.isDenied) {\r\n        permission = await Permission.location.request();\r\n      }\r\n\r\n      if (permission.isPermanentlyDenied) {\r\n        _status = GpsStatus.noPermission;\r\n        notifyListeners();\r\n        return false;\r\n      }\r\n\r\n      if (permission.isGranted) {\r\n        _status = GpsStatus.ready;\r\n        await _getCurrentLocation();\r\n        notifyListeners();\r\n        return true;\r\n      }\r\n\r\n      _status = GpsStatus.noPermission;\r\n      notifyListeners();\r\n      return false;\r\n    } catch (e) {\r\n      debugPrint('GPS initialization error: $e');\r\n      _status = GpsStatus.disabled;\r\n      notifyListeners();\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /// Get current location once\r\n  Future<LatLng?> _getCurrentLocation() async {\r\n    try {\r\n      final position = await Geolocator.getCurrentPosition(\r\n        desiredAccuracy: LocationAccuracy.high,\r\n      );\r\n      _currentLocation = LatLng(position.latitude, position.longitude);\r\n      notifyListeners();\r\n      return _currentLocation;\r\n    } catch (e) {\r\n      debugPrint('Error getting current location: $e');\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /// Start tracking GPS points for field mapping\r\n  Future<void> startTracking() async {\r\n    if (_isTracking) return;\r\n\r\n    _trackPoints.clear();\r\n    _isTracking = true;\r\n    _status = GpsStatus.tracking;\r\n    notifyListeners();\r\n\r\n    const locationSettings = LocationSettings(\r\n      accuracy: LocationAccuracy.high,\r\n      distanceFilter: 2, // Minimum 2 meters between updates\r\n    );\r\n\r\n    _positionStream = Geolocator.getPositionStream(\r\n      locationSettings: locationSettings,\r\n    ).listen(\r\n      (Position position) {\r\n        final newPoint = LatLng(position.latitude, position.longitude);\r\n        \r\n        // Only add if significantly different from last point\r\n        if (_trackPoints.isEmpty || _shouldAddPoint(newPoint)) {\r\n          _trackPoints.add(newPoint);\r\n          _currentLocation = newPoint;\r\n          notifyListeners();\r\n          debugPrint('GPS Point ${_trackPoints.length}: ${newPoint.latitude}, ${newPoint.longitude}');\r\n        }\r\n      },\r\n      onError: (e) {\r\n        debugPrint('GPS stream error: $e');\r\n      },\r\n    );\r\n  }\r\n\r\n  /// Check if new point should be added (minimum distance check)\r\n  bool _shouldAddPoint(LatLng newPoint) {\r\n    if (_trackPoints.isEmpty) return true;\r\n    \r\n    final lastPoint = _trackPoints.last;\r\n    const distance = Distance();\r\n    final meters = distance.as(LengthUnit.Meter, lastPoint, newPoint);\r\n    \r\n    return meters >= 2.0; // Minimum 2 meters apart\r\n  }\r\n\r\n  /// Stop tracking and close polygon\r\n  Future<List<LatLng>> stopTracking() async {\r\n    _isTracking = false;\r\n    _status = GpsStatus.ready;\r\n    \r\n    await _positionStream?.cancel();\r\n    _positionStream = null;\r\n\r\n    // Auto-close polygon by adding first point at end if needed\r\n    if (_trackPoints.length >= 3) {\r\n      // The polygon will be closed in calculations\r\n    }\r\n\r\n    notifyListeners();\r\n    return List.from(_trackPoints);\r\n  }\r\n\r\n  /// Clear all tracked points\r\n  void clearTrack() {\r\n    _trackPoints.clear();\r\n    notifyListeners();\r\n  }\r\n\r\n  /// Add a manual point (for testing)\r\n  void addManualPoint(LatLng point) {\r\n    _trackPoints.add(point);\r\n    _currentLocation = point;\r\n    notifyListeners();\r\n  }\r\n\r\n  @override\r\n  void dispose() {\r\n    _positionStream?.cancel();\r\n    super.dispose();\r\n  }\r\n}"
        }
    ]
}