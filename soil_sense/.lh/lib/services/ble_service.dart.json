{
    "sourceFile": "lib/services/ble_service.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765222285213,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765222285213,
            "name": "Commit-0",
            "content": "import 'dart:async';\r\nimport 'dart:convert';\r\nimport 'package:flutter/foundation.dart';\r\nimport 'package:flutter_blue_plus/flutter_blue_plus.dart';\r\nimport 'package:permission_handler/permission_handler.dart';\r\n\r\nimport '../models/soil_data.dart';\r\n\r\nenum BleStatus { off, scanning, connecting, connected, disconnected, error }\r\n\r\nclass BleService extends ChangeNotifier {\r\n  BleStatus _status = BleStatus.disconnected;\r\n  BluetoothDevice? _connectedDevice;\r\n  BluetoothCharacteristic? _dataCharacteristic;\r\n  \r\n  final List<SoilData> _soilSamples = [];\r\n  final List<BluetoothDevice> _discoveredDevices = [];\r\n  \r\n  StreamSubscription<List<int>>? _dataSubscription;\r\n  StreamSubscription<BluetoothConnectionState>? _connectionSubscription;\r\n  \r\n  // Simulated data timer for testing without ESP32\r\n  Timer? _simulationTimer;\r\n  bool _isSimulating = false;\r\n\r\n  BleStatus get status => _status;\r\n  BluetoothDevice? get connectedDevice => _connectedDevice;\r\n  List<SoilData> get soilSamples => List.unmodifiable(_soilSamples);\r\n  List<BluetoothDevice> get discoveredDevices => List.unmodifiable(_discoveredDevices);\r\n  bool get isConnected => _status == BleStatus.connected || _isSimulating;\r\n  int get sampleCount => _soilSamples.length;\r\n  \r\n  SoilData? get latestSample => _soilSamples.isNotEmpty ? _soilSamples.last : null;\r\n\r\n  /// Initialize BLE and check permissions\r\n  Future<bool> initialize() async {\r\n    try {\r\n      // Request permissions\r\n      await [\r\n        Permission.bluetooth,\r\n        Permission.bluetoothScan,\r\n        Permission.bluetoothConnect,\r\n      ].request();\r\n\r\n      // Check if Bluetooth is supported\r\n      if (await FlutterBluePlus.isSupported == false) {\r\n        _status = BleStatus.error;\r\n        notifyListeners();\r\n        return false;\r\n      }\r\n\r\n      // Check if Bluetooth is on\r\n      final state = await FlutterBluePlus.adapterState.first;\r\n      if (state != BluetoothAdapterState.on) {\r\n        _status = BleStatus.off;\r\n        notifyListeners();\r\n        return false;\r\n      }\r\n\r\n      _status = BleStatus.disconnected;\r\n      notifyListeners();\r\n      return true;\r\n    } catch (e) {\r\n      debugPrint('BLE initialization error: $e');\r\n      _status = BleStatus.error;\r\n      notifyListeners();\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /// Scan for ESP32 devices\r\n  Future<void> startScan() async {\r\n    if (_status == BleStatus.scanning) return;\r\n\r\n    _discoveredDevices.clear();\r\n    _status = BleStatus.scanning;\r\n    notifyListeners();\r\n\r\n    try {\r\n      await FlutterBluePlus.startScan(\r\n        timeout: const Duration(seconds: 10),\r\n        androidScanMode: AndroidScanMode.lowLatency,\r\n      );\r\n\r\n      FlutterBluePlus.scanResults.listen((results) {\r\n        for (ScanResult r in results) {\r\n          // Look for ESP32 devices (usually named \"ESP32\" or \"SoilSense\")\r\n          if (r.device.platformName.isNotEmpty &&\r\n              !_discoveredDevices.contains(r.device)) {\r\n            _discoveredDevices.add(r.device);\r\n            notifyListeners();\r\n          }\r\n        }\r\n      });\r\n\r\n      await Future.delayed(const Duration(seconds: 10));\r\n      await FlutterBluePlus.stopScan();\r\n      \r\n      _status = BleStatus.disconnected;\r\n      notifyListeners();\r\n    } catch (e) {\r\n      debugPrint('BLE scan error: $e');\r\n      _status = BleStatus.error;\r\n      notifyListeners();\r\n    }\r\n  }\r\n\r\n  /// Connect to a specific device\r\n  Future<bool> connectToDevice(BluetoothDevice device) async {\r\n    try {\r\n      _status = BleStatus.connecting;\r\n      notifyListeners();\r\n\r\n      await device.connect(timeout: const Duration(seconds: 10));\r\n      _connectedDevice = device;\r\n\r\n      // Listen for disconnection\r\n      _connectionSubscription = device.connectionState.listen((state) {\r\n        if (state == BluetoothConnectionState.disconnected) {\r\n          _status = BleStatus.disconnected;\r\n          _connectedDevice = null;\r\n          notifyListeners();\r\n        }\r\n      });\r\n\r\n      // Discover services and find the data characteristic\r\n      List<BluetoothService> services = await device.discoverServices();\r\n      for (var service in services) {\r\n        for (var characteristic in service.characteristics) {\r\n          if (characteristic.properties.notify) {\r\n            _dataCharacteristic = characteristic;\r\n            await _subscribeToData();\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      _status = BleStatus.connected;\r\n      notifyListeners();\r\n      return true;\r\n    } catch (e) {\r\n      debugPrint('BLE connection error: $e');\r\n      _status = BleStatus.error;\r\n      notifyListeners();\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /// Subscribe to data notifications from ESP32\r\n  Future<void> _subscribeToData() async {\r\n    if (_dataCharacteristic == null) return;\r\n\r\n    await _dataCharacteristic!.setNotifyValue(true);\r\n    \r\n    _dataSubscription = _dataCharacteristic!.onValueReceived.listen((value) {\r\n      _parseAndStoreSoilData(value);\r\n    });\r\n  }\r\n\r\n  /// Parse JSON data from ESP32\r\n  void _parseAndStoreSoilData(List<int> value) {\r\n    try {\r\n      final jsonString = utf8.decode(value);\r\n      final jsonData = json.decode(jsonString) as Map<String, dynamic>;\r\n      final soilData = SoilData.fromJson(jsonData);\r\n      _soilSamples.add(soilData);\r\n      notifyListeners();\r\n      debugPrint('Received soil data: $soilData');\r\n    } catch (e) {\r\n      debugPrint('Error parsing soil data: $e');\r\n    }\r\n  }\r\n\r\n  /// Start simulation mode for testing without ESP32\r\n  void startSimulation() {\r\n    if (_isSimulating) return;\r\n    \r\n    _isSimulating = true;\r\n    _status = BleStatus.connected;\r\n    _soilSamples.clear();\r\n    notifyListeners();\r\n\r\n    _simulationTimer = Timer.periodic(const Duration(seconds: 2), (timer) {\r\n      // Generate realistic random soil data\r\n      final soilData = SoilData(\r\n        ph: 5.5 + (DateTime.now().millisecond % 30) / 10, // 5.5 - 8.5\r\n        moisture: 20 + (DateTime.now().millisecond % 500) / 10, // 20 - 70%\r\n        temperature: 18 + (DateTime.now().millisecond % 150) / 10, // 18 - 33Â°C\r\n      );\r\n      _soilSamples.add(soilData);\r\n      notifyListeners();\r\n      debugPrint('Simulated soil data: $soilData');\r\n    });\r\n  }\r\n\r\n  /// Stop simulation\r\n  void stopSimulation() {\r\n    _simulationTimer?.cancel();\r\n    _simulationTimer = null;\r\n    _isSimulating = false;\r\n    _status = BleStatus.disconnected;\r\n    notifyListeners();\r\n  }\r\n\r\n  /// Clear all collected samples\r\n  void clearSamples() {\r\n    _soilSamples.clear();\r\n    notifyListeners();\r\n  }\r\n\r\n  /// Get averaged soil data from all samples\r\n  SoilData getAveragedData() {\r\n    return SoilData.average(_soilSamples);\r\n  }\r\n\r\n  /// Disconnect from device\r\n  Future<void> disconnect() async {\r\n    _dataSubscription?.cancel();\r\n    _connectionSubscription?.cancel();\r\n    _simulationTimer?.cancel();\r\n    \r\n    if (_connectedDevice != null) {\r\n      await _connectedDevice!.disconnect();\r\n    }\r\n    \r\n    _connectedDevice = null;\r\n    _dataCharacteristic = null;\r\n    _isSimulating = false;\r\n    _status = BleStatus.disconnected;\r\n    notifyListeners();\r\n  }\r\n\r\n  @override\r\n  void dispose() {\r\n    disconnect();\r\n    super.dispose();\r\n  }\r\n}"
        }
    ]
}